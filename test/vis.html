
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>vis test</title>

  <style>
    body, html {
      font-family: arial, sans-serif;
      font-size: 9pt;
    }

    #title {
      font-weight: bold;
      text-align: center;
    }

    #visualization {
      box-sizing: border-box;
      width: 100%;
      height: 300px;
    }

    .vis-item {
      padding: 10px 5px;
      text-align: center;
    }

    .vis-item.path-t {
      background-color: rgba(255, 0, 0, 0.9);
    }

    .vis-item.path-nt {
      background-color: rgba(255, 165, 0, 0.9);
    }

    .vis-item.path-fin {
      background-color: rgba(0,255,0,0.9);
    }

    .val-anormale {
      color: red;
    }

    .vis-item p {
      margin-top: 0;
      margin-bottom: 5px;
    }

    .btn {
      background-color: red;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      padding: 10px;
      margin: auto;
      cursor: pointer;
      text-align: center;
      max-width: 100px;
    }
  </style>

  <script src="vis-timeline-graph2d.min.js"></script>
  <link href="vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
  
</head>
<body>
  <p id="title">Suivi longitudinal de Monsieur ___ ____</p>
  <div class="btn" onclick="hideAllEmptySpace(31)">Hide empty space</div>
  <div id="visualization"></div>

  <script>
    var groups = new vis.DataSet([
      {id: 0, content: 'Pathologies', value: 1},
      {id: 1, content: 'Examens et consultations', value: 3},
      {id: 2, content: 'Traitements', value: 2}
    ]);

    // create a dataset with items
    // note that months are zero-based in the JavaScript Date object, so month 3 is April
    var items = new vis.DataSet([
      {id: 0, group: 0, className: 'path-t', content: 'T', title: 'Pathologie T', start: new Date(2014, 3, 17)},
      {id: 1, group: 0, className: 'path-nt', content: 'NT1', title: 'Pathologie NT1',  start: new Date(2014, 5, 17)},
      {id: 2, group: 0, className: 'path-nt', content: 'NT2', title: 'Pathologie NT2',  start: new Date(2014, 6, 25)},
      {id: 3, group: 1, className: 'examen', content: '<p>Hémoglobine=1</p><p>SGOT=2</p><p><span class="val-anormale">Biluribine totale=5</span></p><p>Taux de prothrombine=4</p>', start: new Date(2014, 4, 17)},
      {id: 4, group: 1, className: 'examen', content: 'Hémoglobine=2', start: new Date(2014, 5, 17)},
      {id: 5, group: 1, className: 'examen', content: '<span class="val-anormale">Hémoglobine=5</span>', start: new Date(2014, 7, 17)},
      {id: 6, group: 1, className: 'examen', content: 'Hémoglobine=3', start: new Date(2015, 10, 10)},
      {id: 7, group: 2, className: 'path-t', content: 'Res', title: 'Res | Traitement T',  start: new Date(2014, 4, 17)},
      {id: 8, group: 2, className: 'path-nt', content: 'MO', title: 'MO | Traitement NT',  start: new Date(2014, 6, 17)},
      {id: 9, group: 2, className: 'path-nt', content: 'RF', title: 'RF | Traitement NT',  start: new Date(2014, 7, 5)},
      {id: 10, group: 2, className: 'path-nt', content: 'RE', title: 'RE | Traitement NT',  start: new Date(2014, 6, 29)},
      {id: 11, group: 2, className: 'path-nt', content: 'TC-d', title: 'TC début | Traitement NT',  start: new Date(2014, 8, 23)},
      {id: 12, group: 2, className: 'path-nt', content: 'TC-f', title: 'TC fin | Traitement NT',  start: new Date(2014, 9, 23)},
      {id: 13, group: 2, className: 'path-nt', content: 'CEL', title: 'CEL | Traitement NT',  start: new Date(2014, 9, 10)},
      {id: 14, group: 0, className: 'path-fin', content: 'T', title: 'Fin pathologie T', start: new Date(2014, 4, 25)},
      {id: 15, group: 0, className: 'path-fin', content: 'NT1', title: 'Fin pathologie NT1', start: new Date(2014, 9, 25)},
      {id: 16, group: 0, className: 'path-fin', content: 'NT2', title: 'Fin pathologie NT2', start: new Date(2015, 0, 5)}
    ]);

    // create visualization
    var container = document.getElementById('visualization');

    // calculate end date (now + 6 months)
    var now = new Date();
    var initEnd = now.getTime() + 6 * 1000*60*60*24*30.42; 

    var options = {
      // option groupOrder can be a property name or a sort function
      // the sort function must compare two groups and return a value
      //     > 0 when a > b
      //     < 0 when a < b
      //       0 when a == b
      groupOrder: function (a, b) {
        return a.value - b.value;
      },
      editable: false,
      multiselect: false,
      hiddenDates: [/*{start: '2014-08-23 00:00:00', end: '2015-11-01 00:00:00'}*/
                    ],
      end: initEnd
    };

    var timeline = new vis.Timeline(container);
    timeline.setOptions(options);
    timeline.setGroups(groups);
    timeline.setItems(items);

    function hideEmptySpaceUntilNow (tolerance) {
      // find oldest item's date
      // convoluted, use forEach() instead ?
      let oldestDate = new Date(1970, 0, 1);
      let oldItems = items.get({
        filter: function (item) {
          if(item.start.getTime() > oldestDate.getTime()){
            oldestDate.setTime(item.start.getTime());
            return 1;
          }return 0;
        }
      });
      /*let oldestItem = oldItems[oldItems.length];*/
      
     /* alert('Oldest date found : ' + oldestDate.toString());*/
      let offset = 1000 * 60 * 60 * 24 * tolerance;
      oldestDate.setTime(oldestDate.getTime() + offset);
      options.hiddenDates.push({start: oldestDate, end: new Date()});
    }


    function hideEmptySpaceAroundItem (item, tolerance) {
      let msTolerance = 1000 * 60 * 60 * 24 * tolerance;
      
      // find lower and upper limit (start -/+ tolerance)
      let limitLow = lowerLimit(item, msTolerance);
      let limitHigh = upperLimit(item, msTolerance);

      // TODO find closest upper limit from items that started before
      let closestUpperLimit = new Date(1970,0,1);
      items.get({
        filter: function (i) {
          let itemUpperLimit = upperLimit(i, msTolerance);
          if(itemUpperLimit > closestUpperLimit.getTime() && itemUpperLimit < limitHigh){
            closestUpperLimit.setTime(itemUpperLimit);
          }
          return false;
        }
      });
      
      // TODO find closest lower limit from items that started before
      let closestLowerLimit;


      // delete range between those limits if necessary
      if(closestUpperLimit < limitLow) {
        options.hiddenDates.push({start: closestUpperLimit, end: limitLow});
      }
      if(closestLowerLimit > limitHigh) {
        options.hiddenDates.push({start: limitHigh, end: closestLowerLimit});
      }
    }

    // TODO: hide all dates that are more than **tolerance** days away from any item
    function hideAllEmptySpace (tolerance) {
      // For each item except for first and last items :  
        // if is not first or last item hideEmptySpaceAroundItem(item, tolerance)
      let firstDate = timeline.getItemRange().min;
      let lastDate = timeline.getItemRange().max;
      items.get({
        filter: function (i) {
          if (i.start != firstDate && i.start != lastDate && i.end != lastDate) {
            hideEmptySpaceAroundItem(i, tolerance);
          }
          return false;
        }
      });

      // hide space after last item until present date
      hideEmptySpaceUntilNow(tolerance);

      redrawTimeline();
    }

    function lowerLimit(item, msTolerance) {
      return item.start.getTime() - msTolerance;
    }

    function upperLimit(item, msTolerance) {
      return item.start.getTime() + msTolerance;
    }

    function redrawTimeline() {
      timeline.destroy();
      timeline = new vis.Timeline(container, items, groups, options);
    }
/*    hideAllEmptySpace(31);
*/    
  </script>
</body>
</html>